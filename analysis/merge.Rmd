---
title: "Integrating Conflict Data"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

This page shows how to merge Geo-PKO data with conflict data and visualise the results. The examples used here are Uppsala University's ViEWS project, which forecasts conflict risk, and the Uppsala Conflict Data Programme (UCDP), one of the world's leading sources of data on armed conflict. Merging these datasets can provide insights into the links between conflict risk and peacekeeping deployments, and help policymakers make effective peacekeeping decisions where the risk of conflict is high.

## Setting up

Load packages.
```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(sp)
library(tidyr)
library(geojsonio)
library(broom)
library(rgdal)
library(ggplot2)
library(leaflet)
library(sf)
library(spdep)
library(maptools)
library(plyr)
library(rjson)
library(RJSONIO)
library(rmapshaper)
library(htmltools)
library(htmlwidgets)
library(leaflet.providers)
```

## Geo-PKO x ViEWS
First, we import the datasets. We're using the published Geo-PKO dataset, and conflict forecast data from ViEWS for state-based conflict, non-state conflict, and one-sided violence over the next 36 months in Africa. Both datasets offer insights into the sub-national level, using a unique "PRIO-grid" identifier. The PRIO-grid is an innovative geospatial unit from the Peace Research Institute Oslo that divides the world into roughly 100km x 100km squares, allowing geographic analysis beyond the country level to be streamlined.

```{r, warning=FALSE, message=FALSE}
geopko <- read.csv("C:/Users/tanus/Documents/R/GeoPKO/data/Geo_PKO_v2_ISO3.csv") #replace file later
#unzip("data/ViEWS.zip", exdir="data/ViEWS")
predictors <- read.csv("C:/Users/tanus/Documents/R/GeoPKO/data/ViEWS/ensemble_pgm.csv")
```

The Geo-PKO dataset includes detail on troop deployment numbers, types of troops, non-troop deployments, and contributing countries.
 
```{r, warning=FALSE, message=FALSE}
library(kableExtra)
kable(geopko[9546:9550,]) %>% kable_styling() %>%
  scroll_box(width = "100%", height = "200px")
```

### Filtering, joining and subsetting the datasets at the PRIO-grid level

The predictor database begins with July 2020 and forecasts the risk of conflict over the next 36 months ahead. Here's a preview of the data within it, showing state-based (`sb`), non-state (`ns`) and one-sided violence (`os`) forecasts. The variable `month_id` codes months differently to the Geo-PKO dataset, with every month assigned a different numeric value.

```{r, warning=FALSE, message=FALSE}
kable(predictors[90545:90550,]) %>% kable_styling() %>%
  scroll_box(width = "100%", height = "200px")
```

The Geo-PKO dataset we're working with includes data from previous years, but for this visualisation, we will only use the latest year (2019). First, we need to filter the data to include only that period. This way we'll be looking at deployment status against projected conflict risk from the end of that period until three years from that period. You'll see both the Geo-PKO and ViEWS datasets include the PRIO-grid identification variable (`pg_id or prioid`), which corresponds to a specific grid square on the map. This is what we'll use to merge the datasets. In addition to filtering for the time period we want, we will also calculate the average number of troops deployed over that time period.

geopko$mission <- geopko$Mission
geopko$prioid <- geopko$PRIOID
geopko$no.troops <- geopko$No.troops


```{r, warning=FALSE, message=FALSE}
# filtering for troop deployments over 2019

geopko2 <- geopko %>%
  select(mission, year, month, prioid, no.troops, country, location, latitude, longitude) %>%
  filter(year==2019)

geopko2$no.troops <- as.numeric(geopko2$no.troops)

# calculating an average number of troops

geopko3 <- geopko2 %>% 
  group_by(prioid) %>%
  dplyr::mutate(no.troops = mean(no.troops, na.rm=TRUE)) %>%
  ungroup() %>%
  filter (! duplicated(no.troops))

geopko3$no.troops <- round(geopko3$no.troops)

```

Here, we also calculate the average conflict risk (state-based, non-state, and one-sided) for each location.

```{r, warning=FALSE, message=FALSE}
predictors2 <- predictors %>% 
  group_by(pg_id) %>%
  dplyr::mutate(average_allwthematic_sb = mean(average_allwthematic_sb, na.rm=TRUE)) %>%
  dplyr::mutate(average_allwthematic_ns = mean(average_allwthematic_ns, na.rm=TRUE)) %>%
  dplyr::mutate(average_allwthematic_os = mean(average_allwthematic_os, na.rm=TRUE)) %>%
  filter (! duplicated(average_allwthematic_sb))
```


Finally, we merge the two datasets.

```{r, warning=FALSE, message=FALSE}
# merging geopko with conflict forecast data

geopko3$pg_id <- geopko3$prioid

priogriddf <- full_join(
  geopko3, predictors2,
  by = c("pg_id"), 
  na.rm = TRUE)
  
```

### Merging the data and preparing the shapefile

Like we mentioned before, the PRIO-grid unit involves dividing the entire world into roughly 100km x 100km squares. That means that if we want to map it, we'll be working with large files, so keep that in mind when you're reading in the shapefile:

```{r, message=FALSE, warning=FALSE}
shapefile <- rgdal::readOGR("C:/Users/tanus/Documents/R/R Files/ViEWS/priogrid.geojson")
```

The shapefile contains both geospatial polygon data and numerical data that corresponds to the ViEWS dataset; specifically, a PRIO-grid ID and a country ID. To work with the data within this shapefile, we need to fortify it. This converts it into a dataframe. We also convert the IDs to rownames to make it easier to work with. And, finally, we merge it with `pgnewdf2`, which we created earlier.

```{r, warning=FALSE, message=FALSE}

# fortify
shapefile@data$id <- rownames(shapefile@data)
shapefile.df <- fortify(shapefile, region = "id")

# merge data
shapefile.df <- merge(shapefile, priogriddf, by.x = "pg_id", by.y = "pg_id", all.x=F, all.y=T, duplicateGeoms=TRUE)

```

Now `shapefile.df` has the new attributes, including variables from both Geo-PKO and ViEWS. `id` is a variable that ties the 'polygon', or a single square on the grid, to its location on the map
 
```{r, warning=FALSE, message=FALSE}
kable(shapefile.df@data[356:360,]) %>% kable_styling() %>%
  scroll_box(width = "100%", height = "200px")
```

### Mapping Geo-PKO and ViEWS data

To map the data, we're going to use the `leaflet` package (and a bunch of others to support it). The first thing we do is set up our colour palette and bins. We're using the 'viridis' colour palette, designed for accessibility and continuous-scale representation. The other thing we include is a small segment of code that fixes spacing between any NA value in the legend, and the remainder of the legend, making it easier to see.

```{r, warning=FALSE, message=FALSE}
bins <- c(0, 10, 20, 50, 100, 200, 500, 1000, Inf)
pal <- colorNumeric("viridis", NULL)

#to fix spacing of NA in legend
css_fix <- "div.info.legend.leaflet-control br {clear: both;}" # CSS to correct spacing
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
```

Next, let's map. We include three colour layers to shade squares according to their conflict forecast value. These layers can be toggled between state-based conflict, non-state conflict, and one-sided violence. Simple markers show where troops are deployed. Troop deployment numbers are included as labels, which you can see for each square on hover.

```{r, warning=FALSE, message=FALSE}
map <- leaflet(shapefile.df) %>%
  addTiles() %>%
  addPolygons(
    color = "#444444", weight = 0.25, smoothFactor = 0.5,
    opacity = 0.05, fillOpacity = 0.4,
    fillColor = ~ pal(shapefile.df$average_allwthematic_sb),
    group = "State-Based Conflict",
    highlightOptions = highlightOptions(
      color = "white", weight = 2,
      bringToFront = FALSE
    )
  ) %>%
  addPolygons(
    color = "#444444", weight = 0.25, smoothFactor = 0.5,
    opacity = 0.05, fillOpacity = 0.4,
    fillColor = ~ pal(shapefile.df$average_allwthematic_ns),
    group = "Non-State Conflict",
    highlightOptions = highlightOptions(
      color = "white", weight = 2,
      bringToFront = FALSE
    )
  ) %>%
  addPolygons(
    color = "#444444", weight = 0.25, smoothFactor = 0.5,
    opacity = 0.05, fillOpacity = 0.4,
    fillColor = ~ pal(shapefile.df$average_allwthematic_os),
    group = "One-Sided Violence",
    highlightOptions = highlightOptions(
      color = "white", weight = 2,
      bringToFront = FALSE
    )
  ) %>%
  addCircleMarkers((data <- shapefile.df@data$no.troops > 0),
    lat = ~latitude, lng = ~longitude,
    weight = 1, radius = 2, fillOpacity = 0.6, color = "darkblue"
  ) %>%
  addPolygons(
    color = "#444444", weight = 0.1, smoothFactor = 0.5,
    opacity = 0.0, fillOpacity = 0.0,
    fillColor = ~ pal(shapefile.df@data$no.troops),
    label = paste("Troops Deployed: ", shapefile.df@data$no.troops),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px", color = "blue"),
      textsize = "15px", direction = "auto"
    ),
    highlightOptions = highlightOptions(
      color = "white", weight = 2,
      bringToFront = FALSE
    )
  ) %>%
  addLegend("bottomright",
    pal = pal,
    values = shapefile.df$average_allwthematic_sb,
    title = "Conflict Forecast",
    opacity = 1
  ) %>%
  addLayersControl(
    baseGroups = c("State-Based Conflict", "Non-State Conflict", "One-Sided Violence"),
    options = layersControlOptions(collapsed = FALSE)
  )

map <- map %>% htmlwidgets::prependContent(html_fix) # legend NA fix

# to save as HTML, you can use the following code:
# saveWidget(map, file="pkoviews - priogrid.html")

map

```

And here we have it: an interactive map to view the latest peacekeeping data and projected conflict risk over the next 36 months. We can also do the same but with a world terrain basemap to identify, at a basic level, potential geographic impacts such as the greater concentration of conflict risk in mountainous areas, and the general deployment of peacekeepers in non-mountainous areas.

```{r}

# adding provider tiles - replaces addTiles()
map <- map %>% addProviderTiles("Esri.WorldTerrain")

map
```

Extensions of this visualisation can be even more useful, particularly with a time-slider that can help us identify how the risk of conflict changes given peacekeeping deployments (and vice versa). That might be a project for the future.